<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>座標マッピングアプリ</title>
    <link rel="stylesheet" href="../../assets/style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>座標マッピングアプリ</h1>
            <p>画像をアップロードして座標データに基づいてマーカーを配置</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="imageInput">背景画像を選択:</label>
                <input type="file" id="imageInput" accept="image/*">
            </div>
            
            <div class="control-group">
                <label>表示モード:</label>
                <button id="displayToggle" class="toggle-btn">アイコン表示</button>
            </div>
            
            <div class="control-group">
                <label>ズーム操作:</label>
                <div style="display: flex; gap: 10px;">
                    <button id="zoomIn" class="toggle-btn" style="padding: 8px 15px;">拡大 (+)</button>
                    <button id="zoomOut" class="toggle-btn" style="padding: 8px 15px;">縮小 (-)</button>
                    <button id="zoomReset" class="toggle-btn" style="padding: 8px 15px;">リセット</button>
                </div>
            </div>
            
            <div id="statusInfo" class="status-info" style="display: none;">
                座標: 0個
            </div>
        </div>

        <div class="input-section">
            <div class="control-group">
                <label for="coordinateInput">座標データ (JavaScript オブジェクト形式):</label>
                <textarea id="coordinateInput" class="coordinate-input" placeholder="座標データを入力してください...">{'地点A':[2921, 3186],
'地点B':[2796, 3208],
'地点C':[2577, 6462]}</textarea>
                <div class="example">例: {'場所名1':[x座標, y座標], '場所名2':[x座標, y座標]}</div>
                <div id="error" class="error" style="display: none;"></div>
            </div>
        </div>

        <div class="canvas-container">
            <div id="canvasWrapper" class="canvas-wrapper" style="display: none;">
                <canvas id="imageCanvas"></canvas>
            </div>
            <div id="noImage" class="no-image">
                画像をアップロードしてください
            </div>
        </div>
    </div>

    <script>
        let currentImage = null;
        let coordinates = {};
        let displayMode = 'icon'; // 'icon' or 'label'
        let imageScale = 1;
        let zoomLevel = 1;
        let panX = 0;
        let panY = 0;
        let isDragging = false;
        let lastMouseX = 0;
        let lastMouseY = 0;

        const imageInput = document.getElementById('imageInput');
        const canvas = document.getElementById('imageCanvas');
        const ctx = canvas.getContext('2d');
        const canvasWrapper = document.getElementById('canvasWrapper');
        const noImage = document.getElementById('noImage');
        const coordinateInput = document.getElementById('coordinateInput');
        const displayToggle = document.getElementById('displayToggle');
        const errorDiv = document.getElementById('error');
        const zoomInBtn = document.getElementById('zoomIn');
        const zoomOutBtn = document.getElementById('zoomOut');
        const zoomResetBtn = document.getElementById('zoomReset');
        const statusInfo = document.getElementById('statusInfo');

        // 画像アップロード処理
        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        currentImage = img;
                        setupCanvas();
                        updateMarkers();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // 座標データ入力処理
        coordinateInput.addEventListener('input', function() {
            parseCoordinates();
            updateMarkers();
        });

        // 表示モード切り替え
        displayToggle.addEventListener('click', function() {
            displayMode = displayMode === 'icon' ? 'label' : 'icon';
            displayToggle.textContent = displayMode === 'icon' ? 'アイコン表示' : '名前表示';
            updateMarkers();
        });

        // ズーム機能
        zoomInBtn.addEventListener('click', () => {
            zoomLevel = Math.min(zoomLevel * 1.2, 5);
            updateCanvas();
        });

        zoomOutBtn.addEventListener('click', () => {
            zoomLevel = Math.max(zoomLevel / 1.2, 0.1);
            updateCanvas();
        });

        zoomResetBtn.addEventListener('click', () => {
            zoomLevel = 1;
            panX = 0;
            panY = 0;
            updateCanvas();
        });

        // マウスホイールズーム
        canvasWrapper.addEventListener('wheel', function(e) {
            e.preventDefault();
            const rect = canvasWrapper.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            const oldZoom = zoomLevel;
            if (e.deltaY < 0) {
                zoomLevel = Math.min(zoomLevel * 1.1, 5);
            } else {
                zoomLevel = Math.max(zoomLevel / 1.1, 0.1);
            }
            
            // ズーム中心をマウス位置に調整
            const zoomRatio = zoomLevel / oldZoom;
            panX = mouseX - (mouseX - panX) * zoomRatio;
            panY = mouseY - (mouseY - panY) * zoomRatio;
            
            updateCanvas();
        });

        // ドラッグ機能
        canvasWrapper.addEventListener('mousedown', function(e) {
            if (zoomLevel > 1) {
                isDragging = true;
                lastMouseX = e.clientX;
                lastMouseY = e.clientY;
                canvasWrapper.style.cursor = 'grabbing';
            }
        });

        document.addEventListener('mousemove', function(e) {
            if (isDragging) {
                const deltaX = e.clientX - lastMouseX;
                const deltaY = e.clientY - lastMouseY;
                panX += deltaX;
                panY += deltaY;
                lastMouseX = e.clientX;
                lastMouseY = e.clientY;
                updateCanvas();
            }
        });

        document.addEventListener('mouseup', function() {
            if (isDragging) {
                isDragging = false;
                canvasWrapper.style.cursor = zoomLevel > 1 ? 'grab' : 'default';
            }
        });

        // キャンバスセットアップ
        function setupCanvas() {
            if (!currentImage) return;

            // 初期設定をリセット
            zoomLevel = 1;
            panX = 0;
            panY = 0;

            // キャンバスサイズを画像に合わせて設定
            const maxWidth = Math.min(1000, window.innerWidth - 80);
            const maxHeight = Math.min(600, window.innerHeight - 300);
            
            let canvasWidth = currentImage.width;
            let canvasHeight = currentImage.height;

            // 画像が大きすぎる場合はリサイズ
            if (canvasWidth > maxWidth || canvasHeight > maxHeight) {
                const widthRatio = maxWidth / canvasWidth;
                const heightRatio = maxHeight / canvasHeight;
                imageScale = Math.min(widthRatio, heightRatio);
                
                canvasWidth = currentImage.width * imageScale;
                canvasHeight = currentImage.height * imageScale;
            } else {
                imageScale = 1;
            }

            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            
            updateCanvas();
            
            // キャンバスを表示
            canvasWrapper.style.display = 'inline-block';
            noImage.style.display = 'none';
        }

        // キャンバス更新（ズーム・パン対応）
        function updateCanvas() {
            if (!currentImage) return;

            // キャンバスをクリア
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 変換行列を設定
            ctx.save();
            ctx.translate(panX, panY);
            ctx.scale(zoomLevel, zoomLevel);
            
            // 画像を描画
            const displayWidth = currentImage.width * imageScale;
            const displayHeight = currentImage.height * imageScale;
            ctx.drawImage(currentImage, 0, 0, displayWidth, displayHeight);
            
            ctx.restore();
            
            // ズーム状態に応じてスタイルを更新
            if (zoomLevel > 1) {
                canvasWrapper.classList.add('zoomed');
                canvasWrapper.style.cursor = 'grab';
            } else {
                canvasWrapper.classList.remove('zoomed');
                canvasWrapper.style.cursor = 'default';
            }
            
            updateMarkers();
        }

        // 座標データ解析
        function parseCoordinates() {
            errorDiv.style.display = 'none';
            
            try {
                let inputText = coordinateInput.value.trim();
                if (!inputText) {
                    coordinates = {};
                    return;
                }

                // コメント行（#で始まる行）を削除
                inputText = inputText.replace(/^\s*#.*$/gm, '');
                
                // 行内コメント（#以降）を削除
                inputText = inputText.replace(/#.*$/gm, '');
                
                // 複数行にわたる場合の改行や空白を整理
                inputText = inputText.replace(/\s*\n\s*/g, '');
                
                // 先頭と末尾の波括弧を追加（ない場合）
                if (!inputText.startsWith('{')) {
                    inputText = '{' + inputText;
                }
                if (!inputText.endsWith('}')) {
                    inputText = inputText + '}';
                }

                // 末尾のカンマを削除（波括弧の直前）
                inputText = inputText.replace(/,(\s*})/, '$1');

                // まずevalで試す（JavaScript形式）
                try {
                    const coordObject = eval('(' + inputText + ')');
                    // 結果が正しいオブジェクトかチェック
                    if (typeof coordObject === 'object' && coordObject !== null) {
                        let validCoords = {};
                        for (const [key, value] of Object.entries(coordObject)) {
                            if (Array.isArray(value) && value.length >= 2 && 
                                typeof value[0] === 'number' && typeof value[1] === 'number') {
                                validCoords[key] = [value[0], value[1]];
                            }
                        }
                        coordinates = validCoords;
                        console.log(`成功: ${Object.keys(validCoords).length}個の座標を読み込みました`);
                        updateStatus(Object.keys(validCoords).length);
                        return;
                    }
                } catch (evalError) {
                    // evalが失敗した場合はJSONを試す
                }

                // JSONとして解析を試す
                let jsonText = inputText.replace(/'/g, '"');
                const coordObject = JSON.parse(jsonText);
                
                // 結果をバリデーション
                let validCoords = {};
                for (const [key, value] of Object.entries(coordObject)) {
                    if (Array.isArray(value) && value.length >= 2 && 
                        typeof value[0] === 'number' && typeof value[1] === 'number') {
                        validCoords[key] = [value[0], value[1]];
                    }
                }
                coordinates = validCoords;
                console.log(`成功: ${Object.keys(validCoords).length}個の座標を読み込みました`);
                updateStatus(Object.keys(validCoords).length);
                
            } catch (error) {
                coordinates = {};
                updateStatus(0);
                errorDiv.innerHTML = `
                    <strong>エラー:</strong> 座標データの形式が正しくありません。<br>
                    <strong>対応形式:</strong><br>
                    • {'場所名':[x, y], '場所名2':[x, y]}<br>
                    • '場所名':[x, y], '場所名2':[x, y]<br>
                    • 複数行での入力も可能<br>
                    • # でのコメントも対応<br>
                    <strong>エラー詳細:</strong> ${error.message}
                `;
                errorDiv.style.display = 'block';
            }
        }

        // マーカー更新
        function updateMarkers() {
            if (!currentImage) {
                parseCoordinates(); // エラーチェックのために実行
                return;
            }

            // 既存のマーカーを削除
            const existingMarkers = canvasWrapper.querySelectorAll('.marker');
            existingMarkers.forEach(marker => marker.remove());

            // 新しいマーカーを作成
            Object.entries(coordinates).forEach(([name, [x, y]]) => {
                createMarker(name, x, y);
            });
        }

        // マーカー作成
        function createMarker(name, x, y) {
            const marker = document.createElement('div');
            marker.className = 'marker';
            
            // 座標をキャンバス上の位置に変換（ズーム・パン考慮）
            const canvasX = (x * imageScale * zoomLevel) + panX;
            const canvasY = (y * imageScale * zoomLevel) + panY;
            
            marker.style.left = canvasX + 'px';
            marker.style.top = canvasY + 'px';
            
            // ズームレベルに応じてマーカーサイズを調整
            const markerScale = Math.max(0.5, Math.min(1.5, 1 / Math.sqrt(zoomLevel)));
            marker.style.transform = `translate(-50%, -50%) scale(${markerScale})`;

            if (displayMode === 'icon') {
                // アイコンモード
                const icon = document.createElement('div');
                icon.className = 'marker-icon';
                marker.appendChild(icon);
                
                // ツールチップ
                marker.addEventListener('mouseenter', function(e) {
                    const tooltip = document.createElement('div');
                    tooltip.className = 'tooltip';
                    tooltip.textContent = name;
                    marker.appendChild(tooltip);
                });
                
                marker.addEventListener('mouseleave', function() {
                    const tooltip = marker.querySelector('.tooltip');
                    if (tooltip) {
                        tooltip.remove();
                    }
                });
            } else {
                // ラベルモード
                const label = document.createElement('div');
                label.className = 'marker-label';
                label.textContent = name;
                marker.appendChild(label);
            }

            canvasWrapper.appendChild(marker);
        }

        // ステータス更新
        function updateStatus(count) {
            if (count > 0) {
                statusInfo.textContent = `座標: ${count}個`;
                statusInfo.style.display = 'block';
            } else {
                statusInfo.style.display = 'none';
            }
        }

        // 初期化
        parseCoordinates();
        
        // ウィンドウリサイズ対応
        window.addEventListener('resize', function() {
            if (currentImage) {
                setupCanvas();
            }
        });
    </script>
</body>
</html>
